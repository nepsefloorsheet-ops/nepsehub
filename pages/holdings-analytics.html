<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Holdings Analytics | NEPSE Hub</title>
    <link
      rel="shortcut icon"
      href="../img/favicon/NH.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="../src/css/global.css" />
    <link rel="stylesheet" href="../src/css/utils/status.css" />
    <link rel="stylesheet" href="../src/css/pages/holdings-analytics.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&family=Roboto+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK & Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../src/js/config.js"></script>
    <script src="../src/js/services/auth-service.js"></script>
  </head>
  <body>
    <div id="layout"></div>

    <main class="active" role="main">
      <header class="header">
        <div class="header-items">
          <div class="header-group">
            <div class="header-col">
              <span class="header-col-label">NEPSE Index</span>
              <div id="nepseData" class="flex gap-10 items-baseline">
                <span class="index-value">--</span>
                <div class="flex column">
                  <span class="difference">--</span>
                  <span class="percent-ch">(--)</span>
                </div>
              </div>
            </div>
            <div class="divider-v"></div>
            <span class="pulse-dot" id="headerPulse"></span>
            <div class="turnover-volume">
              <div class="header-col">
                <div class="header-col-item">
                  <span class="header-col-label">Total Turnover</span>
                  <span class="header-col-value turnover">--</span>
                </div>
                <div class="header-col-item">
                  <span class="header-col-label">Total Volume</span>
                  <span class="header-col-value volume">--</span>
                </div>
              </div>
            </div>
          </div>

          <div class="header-group">
            <div class="header-col right">
              <span
                id="currentDate"
                class="header-col-label"
                style="font-size: 0.9rem"
                >---, -- ---</span
              >
              <span
                id="currentTime"
                class="header-col-value"
                style="font-size: 0.9rem"
                >--:--:--</span
              >
            </div>
            <div class="divider-v"></div>
            <div class="header-col items-center">
              <div class="flex items-center gap-8" style="margin-bottom: 2px">
                <span id="market-status" class="market-pill">Checking...</span>
              </div>
              <div class="theme-switcher">
                <button class="theme-btn" data-theme="dark" title="Dark Mode">
                  <i class="fa-solid fa-moon"></i>
                </button>
                <button class="theme-btn" data-theme="light" title="Light Mode">
                  <i class="fa-regular fa-sun"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="institutional-container">
        <!-- Dashboard Top Header -->
        <div class="flex justify-between items-end mb-20">
          <div>
            <h1 class="text-36 font-800 text-primary tracking-tight mb-4">
              Broker <span class="text-muted font-400">Holdings</span>
            </h1>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="analytics-filter-bar mb-24">
          <div class="filter-inputs-grid">
            <div class="filter-field">
              <label>Broker ID</label>
              <div class="input-with-icon">
                <i class="fas fa-user-tie"></i>
                <input
                  type="number"
                  id="broker-filter"
                  placeholder="All Brokers"
                />
              </div>
            </div>
            <div class="filter-field">
              <label>Symbol</label>
              <div class="symbol-filter-wrapper">
                <div class="input-with-icon">
                  <i class="fas fa-search"></i>
                  <input
                    type="text"
                    id="symbol-filter"
                    placeholder="Select a symbol..."
                    autocomplete="off"
                  />
                </div>
                <div class="symbol-dropdown-list" id="symbol-dropdown">
                  <!-- Dropdown items populated by JS -->
                </div>
              </div>
            </div>
            <div class="filter-field date-range-field">
              <label>Custom Date Range</label>
              <div class="date-picker-group">
                <div class="input-with-icon">
                  <i class="fas fa-calendar-alt"></i>
                  <input type="date" id="start-date" title="Start date" />
                </div>
                <span>to</span>
                <div class="input-with-icon">
                  <i class="fas fa-calendar-alt"></i>
                  <input type="date" id="end-date" title="End date" />
                </div>
              </div>
            </div>
            <div class="filter-field search-action-field">
              <button id="search-btn" class="btn-terminal primary">
                <i class="fas fa-search"></i> Search Analysis
              </button>
            </div>
          </div>

          <div class="quick-filters-row mt-16">
            <div class="quick-dates-group">
              <button class="date-chip active" data-range="1D">1D</button>
              <button class="date-chip" data-range="1W">1W</button>
              <button class="date-chip" data-range="1M">1M</button>
              <button class="date-chip" data-range="3M">3M</button>
              <button class="date-chip" data-range="1Y">1Y</button>
            </div>
            <div class="divider-v" style="height: 24px"></div>
            <button
              id="clear-filters-btn"
              class="btn-terminal secondary text-12"
            >
              <i class="fas fa-times"></i> Clear Filters [Esc]
            </button>
          </div>
        </div>

        <!-- Summary Statistics -->
        <div class="stats-grid mb-24">
          <div class="stat-card">
            <div class="stat-icon buy"><i class="fas fa-chart-line"></i></div>
            <div class="stat-info">
              <span class="stat-label">Total Volume</span>
              <h3 id="stat-total-volume">--</h3>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon turnover"><i class="fas fa-wallet"></i></div>
            <div class="stat-info">
              <span class="stat-label">Total Turnover</span>
              <h3 id="stat-total-turnover">--</h3>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon entities">
              <i class="fas fa-building"></i>
            </div>
            <div class="stat-info">
              <span class="stat-label" id="stat-entities-label"
                >Active Brokers</span
              >
              <h3 id="stat-active-entities">--</h3>
            </div>
          </div>
        </div>

        <!-- Global Loading State -->
        <div id="chart-loading-overlay" class="overlay hidden">
          <div class="spinner"></div>
        </div>

        <!-- Aggregated Summary Table (Instant View) + Bar Chart -->
        <div class="flex space-between gap-24 mb-24 grid">
          <div
            class="analyst-card table-card flex-1"
            id="aggregated-summary-card"
          >
            <div class="card-header-clean">
              <div class="flex items-center gap-16">
                <i class="fas fa-layer-group text-accent-secondary"></i>
                <h3 id="aggregated-table-title">Entity Distribution Summary</h3>
              </div>
            </div>
            <div class="scrollable-table-wrap" style="max-height: 610px">
              <table class="institutional-table" id="aggregated-master-table">
                <thead>
                  <tr>
                    <th id="agg-entity-header">Symbol</th>
                    <th class="text-right">Total Qty</th>
                    <th class="text-right">Total Amount</th>
                    <th class="text-right">Avg. Rate</th>
                    <th class="text-right">Hits</th>
                  </tr>
                </thead>
                <tbody id="aggregated-tbody">
                  <!-- Data populated by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <div
            class="analyst-card chart-card"
            id="aggregated-bar-chart-card"
            style="width: 49%"
          >
            <div class="card-header-clean">
              <div class="flex items-center gap-16">
                <i class="fas fa-chart-bar text-accent-primary"></i>
                <h3>Holdings by Entity</h3>
              </div>
              <div class="chart-controls" style="margin-left: auto">
                <nav class="flex" role="tablist" aria-label="Chart metric">
                  <button
                    class="chart-toggle btn-terminal primary active"
                    data-metric="total_qty"
                  >
                    Qty
                  </button>
                  <button
                    class="chart-toggle btn-terminal secondary"
                    data-metric="total_amount"
                  >
                    Amount
                  </button>
                </nav>
              </div>
            </div>
            <div class="chart-wrap" style="padding: 16px">
              <canvas
                id="aggregated-bar-chart"
                width="400"
                height="500"
              ></canvas>
            </div>
          </div>
        </div>

        <!-- Holdings Table Section -->
        <div class="analyst-card table-card" id="audit-logs">
          <div class="card-header-clean">
            <div class="flex items-center gap-16">
              <i class="fas fa-list-ul text-accent-primary"></i>
              <h3>Holding Audit Logs</h3>
            </div>
            <div class="table-actions">
              <span class="results-count" id="table-results-info"
                >Showing 0 records</span
              >
            </div>
          </div>

          <div class="scrollable-table-wrap">
            <table class="institutional-table" id="holdings-master-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort="date">
                    Date <i class="fas fa-sort"></i>
                  </th>
                  <th class="sortable" data-sort="broker_id">
                    Broker ID <i class="fas fa-sort"></i>
                  </th>
                  <th class="sortable" data-sort="symbol">
                    Symbol <i class="fas fa-sort"></i>
                  </th>
                  <th class="sortable text-right" data-sort="qty">
                    Qty <i class="fas fa-sort"></i>
                  </th>
                  <th class="sortable text-right" data-sort="amount">
                    Amount <i class="fas fa-sort"></i>
                  </th>
                </tr>
              </thead>
              <tbody id="holdings-tbody">
                <!-- Data populated by JS -->
              </tbody>
            </table>
          </div>

          <div class="table-footer-pagination">
            <div class="pagination-info">
              Page <span id="current-page">1</span> of
              <span id="total-pages">1</span>
            </div>
            <div class="pagination-controls">
              <button id="prev-page-btn" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="page-numbers" id="pagination-numbers"></div>
              <button id="next-page-btn" disabled>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="../src/js/layout.js"></script>
    <script src="../src/js/utils/status.js"></script>
    <script src="../src/js/utils/cleanup-manager.js"></script>
    <script src="../src/js/utils/error-handler.js"></script>
    <script src="../src/js/services/api-service.js"></script>
    <script src="../src/js/global.js"></script>
    <script src="../src/js/market/holdings-analytics.js"></script>
  </body>
</html>
